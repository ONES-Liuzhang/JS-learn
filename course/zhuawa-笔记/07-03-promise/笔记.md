# 0703 Promise è§„èŒƒ

## PromiseA+è§„èŒƒ

### æœ¯è¯­

1. promise æ˜¯ä¸€ä¸ªæœ‰ then æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œå®ƒéµå¾ª promiseA+è§„èŒƒ
2. thenable æ˜¯ä¸€ä¸ªæœ‰ then æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°
3. value æ˜¯ promise çŠ¶æ€æˆåŠŸæ—¶çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ resolve çš„å‚æ•°ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹
4. reason æ˜¯ promise çŠ¶æ€å¤±è´¥æ—¶çš„å€¼ï¼Œä¹Ÿæ˜¯ reject çš„å‚æ•°ï¼Œè¡¨ç¤ºæ‹’ç»çš„åŸå› 
5. exception throw æŠ›å‡ºçš„å¼‚å¸¸

---

### è§„èŒƒ

### Promise States

1. pending
   1.1 åˆå§‹çŠ¶æ€
   1.2 åœ¨ resolve æˆ– reject ä¹‹å‰éƒ½å¤„äº pending çŠ¶æ€
   1.3 resolve -> fulfilled
   1.4 reject -> rejected

2. fulfilled
   2.1 æœ€ç»ˆæ€ï¼Œä¸å¯æ”¹å˜
   2.2 å¿…é¡»æ‹¥æœ‰ä¸€ä¸ª value å€¼. å¯ä»¥ä¸º undefined
3. rejected
   3.1 æœ€ç»ˆæ€ï¼Œä¸å¯æ”¹å˜
   3.2 å¿…é¡»æ‹¥æœ‰ä¸€ä¸ª reason. å¯ä»¥ä¸º undefined

pending -> resolve(value) -> fulfilled

pending -> reject(value) -> rejected

### then

Promise å¿…é¡»æä¾›ä¸€ä¸ª then æ–¹æ³•ï¼Œç”¨æ¥è®¿é—®æœ€ç»ˆçš„ç»“æœï¼Œæ— è®ºæ˜¯ value è¿˜æ˜¯ reason

catch åå¦‚æœæˆåŠŸè¿”å›ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆæˆåŠŸåè¿”å›çš„å€¼ä¹Ÿä¼šè¢«åé¢çš„ then æ¥æ”¶ï¼Œä¸¾ä¸ª ğŸŒ°

```js
new Promise((resolve, reject) => {
  reject("reject");
})
  .catch((reason) => {
    console.log("catch reason:", reason);
    return reason;
  })
  .then((res) => {
    console.log("then value:", res);
  });
```

æ‰“å°ç»“æœï¼š
catch reason: reject
then value: reject

1. å‚æ•°è¦æ±‚
   1.1 onFulfilled å¿…é¡»æ˜¯å‡½æ•°ç±»å‹ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°ï¼Œåº”è¯¥è¢«å¿½ç•¥
   1.2 onRejected å¿…é¡»æ˜¯å‡½æ•°ç±»å‹ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°ï¼Œåº”è¯¥è¢«å¿½ç•¥

2. onFulfilled ç‰¹æ€§
   2.1 åœ¨ promise å˜æˆ fulfilled æ—¶ï¼Œ åº”è¯¥è°ƒç”¨ onFulfilledï¼Œå‚æ•°æ˜¯ value
   2.2 åœ¨ promise å˜æˆ fulfilled ä¹‹å‰ï¼Œ ä¸åº”è¯¥è°ƒç”¨ onFulfilled
   2.3 åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡.(_éœ€è¦ä¸€ä¸ªå˜é‡æ¥é™åˆ¶æ‰§è¡Œæ¬¡æ•°_)

Pending -> resolve(value) -> fulfilled -> onFulfilled(value)
çŠ¶æ€å˜åŒ–å¯¼è‡´å‡½æ•°çš„è§¦å‘ï¼Œå¯ä»¥ä½¿ç”¨ getter å’Œ setter æ¥å®ç°

3. onRejected ç‰¹æ€§
   3.1 åœ¨ promise å˜æˆ onRejected æ—¶ï¼Œ åº”è¯¥è°ƒç”¨ onRejectedï¼Œå‚æ•°æ˜¯ reason
   3.2 åœ¨ promise å˜æˆ onRejected ä¹‹å‰ï¼Œ ä¸åº”è¯¥è°ƒç”¨ onRejected
   3.3 åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡

4. onFulfilled å’Œ onRejected åº”è¯¥æ˜¯å¾®ä»»åŠ¡
   queueMicrotask å®ç°å¾®ä»»åŠ¡è°ƒç”¨

5. Then æ–¹æ³•å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡
   5.1 promise å˜æˆ fulfilled ä¹‹åï¼Œæ‰€æœ‰ onFulfilled çš„å›è°ƒéƒ½åº”è¯¥æŒ‰ç…§ then çš„é¡ºåºæ‰§è¡Œ

```js
promise.then(cb1).then(cb2).then(cb3);

let promise = new Promise();
promise.then(cb1);
promise.then(cb2);
promise.then(cb3);
```

5.2 promise å˜æˆ rejected ä¹‹åï¼Œæ‰€æœ‰ onRejected çš„å›è°ƒéƒ½åº”è¯¥æŒ‰ç…§ then çš„é¡ºåºæ‰§è¡Œ

6. è¿”å›å€¼
   then çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª promise

```js
promise2 = promise1.then(onFulfilled, onRejected);
```

6.1 onFulfilled æˆ– onRejected æ‰§è¡Œçš„å‡½æ•°ç»“æœä¸º xï¼Œè°ƒç”¨ resolvePromise.
6.2 onFulfilled æˆ– onRejected æ‰§è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œpromise2 éœ€è¦è¢« reject.
6.3 å¦‚æœ onFulfilled ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œpromise2 ä»¥ promise1 çš„ value è§¦å‘ fulfilled._å€¼çš„é€ä¼ _
6.4 å¦‚æœ onRejected ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œpromise2 ä»¥ promise1 çš„ reason è§¦å‘ rejected.

7. resolvePromise

```js
resolvePromise(promise2, x, resolve, reject);
```

7.1 å¦‚æœ promise2 å’Œ x ç›¸ç­‰ï¼Œ reject TypeError
promise2 å’Œ x ç›¸ç­‰ä¼šå¯¼è‡´æ— é™å¾ªç¯è°ƒç”¨

7.2 å¦‚æœ x æ˜¯ä¸€ä¸ª promise
å¦‚æœ x æ˜¯ pendingï¼Œpromise å¿…é¡»ç­‰å¾…/pending ç›´åˆ° x fulfilled / rejected
å¦‚æœ x æ˜¯ fulfilledï¼Œ fulfill promise with the same value.
å¦‚æœ x æ˜¯ rejectedï¼Œ reject promise with the same reason.
7.3 å¦‚æœä¸æ˜¯ä¸€ä¸ª promise
å¦‚æœæ˜¯ object æˆ–è€… functionï¼Œåˆ¤æ–­æœ‰æ²¡æœ‰ then æ–¹æ³•*ï¼ˆæ˜¯ä¸æ˜¯ PromiseLikeï¼‰*
x = x.then -> å¦‚æœæŠ¥é”™ ç›´æ¥ reject promise with e as the reason.
å¦‚æœ then æ˜¯å‡½æ•°: _promise2 çš„ç»“æ„å°±æ˜¯ then çš„ç»“æœï¼Œè¿™ä¸€æ­¥å¯èƒ½æŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ª then æ˜¯ä¸å¯ä¿¡ä»»çš„ then æ–¹æ³•ï¼Œè¦æ·»åŠ  try/catch å¹¶ä¸”ç¡®ä¿å‡½æ•°åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡_
then.call(x, (y) => resolvePromise(promise2, y, resolve, reject),(e) => reject(e))
å¦‚æœ then æ–¹æ³•æ‰§è¡ŒæŠ¥é”™
å¦‚æœ resolvePromiseFn æˆ–è€… rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥
å¦åˆ™ reject promise with e as the reason
å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ç›´æ¥ resolve(x)ï¼Œå³ fulfill promise with x.
