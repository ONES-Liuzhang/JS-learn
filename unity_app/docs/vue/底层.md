
# vue 底层

分为三大块: `core` `compiler` `platform`

## core 
vue的核心灵魂, core是平台无关的

### new Vue()
- 合并$options, 针对子组件会合并父组件上定义的event, props等
- 
- initLifecycle 确定非抽象父子关系及初始化一些实例属性($root, $children, $slots, $refs)
- initEvent 初始化事件中心 _events, 将父组件的通v-on定义的事件添加到事件中心
  - 原生事件

    在执行initEvents之前的模板编译阶段，会判断遇到的是html标签还是组件名，如果是html标签会在转为真实dom之后使用addEventListener注册浏览器原生事件。绑定事件是挂载dom的最后阶段，这里只是初始化阶段，这里主要是处理自定义事件相关，也就是另外一种，这里声明下，大家不要理会错了执行顺序。

  - 自定义事件

    从$options里面读取父组件中传入的自定义事件, 存入事件中心, 然后用$on , $emit 控制调用和触发, 子组件并不是给父组件派发事件, 而是给自己派发, 在事件中心里面找到对应的事件, 然后执行. 这样做事为了跨组件通讯.

- initRender 定义render
  
  挂载可以将render转化为vnode的方法 _c, _createElement 


- callHooks(vm, 'beforeCreate')

- initInjections() 初始化注入的inject数据, 在initState之前是为了让initstate可以用inject

- initState 初始化状态,包括 props data methods computed, watch
    
    会分别初始化 props methods   data computed  watch
    - initProps()
    - initMehods()
    - initData()
    - initComputed()
    - initWatch()
- initProvide() 初始化 _provide

- callHooks(vm, 'created')

- compile 如果是.vue文件的模板, 或者是template 

- $mount
  
  - callHooks(vm, 'beforeMount')
  - vm._update(vm._render())
    - vm._render()  调用传入的render函数
      - `普通元素`转换为 vnode 使用new VNode,
      - `组件元素`转换为 vnode cerateComponent
    - vm._update(vnode)  将 vnode 装换为 DOM
      - `普通vnode`创建真实dom  createElement, createCommon, createTextNode
      - `组件vnode`创建真实dom createComponent, 
        - 实例化组件createComponentInstanceForVnode
        - 手动挂载 vm.$mount(undefined)
      - insert
      - `vm.__patch__(vm.$el, vnode )`
      - diff 算法
    - new Watcher()
  - callHook(vm, 'mounted')

  
- callHooks(vm, 'mounted')

### 挂载

将vnode生成的平台元素append到已知的节点上.

以web平台举例，用vnode通过document.createElement生成dom，然后在append到文档树中某个节点上。后面我们也会经常说到 挂载组件 ，它指的就是执行组件对应render生成vnode，然后遍历vnode生成具体平台元素，组件的根节点元素会被append到父元素上。

### VNode
vnode是虚拟node节点，是具体平台元素对象的进一步抽象，每一个平台元素对应一个vnode，可通过vnode结构完整还原具体平台元素结构 。
经过vue的compile模块将生成render函数, 执行render函数生成对应的vnode结构树.


### Watcher  
一个组件对应一个wather实例,在组件挂载的时候创建这个实例
组件的state( props, data, computed 等)是被观察者, state的变动会导致观察者执行
vm._update(vm.render(), hydrawring), 组件重新生成vnode并patch

一个组件对应一个观察者对应组件里面所有被观察者, 被观察者可能被用于其他组件, 那么一个被观察者会对应多个观察者，当被观察者发生变动时，通知到所有观察者做出更新响应。

整个watcher体系的建立过程
- 创建组件实例, 对组件的data, props, computed等状态进行observer.
- 对 props 进行浅层的遍历,重新定义get, set
- 对 data 进行深层遍历, 重新定义get,set
- 在mountComponent的时候, 会创建 watcher, 然后执行 vm._update(vm._render(),hydrating, ), watcher会被pushTarget 
- 
